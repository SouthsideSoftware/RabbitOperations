@{
    ViewBag.Title = "Rabbit Operations";
    Layout = "layout.cshtml";
}

<div>
    <h1 class="page-header">Search</h1>

    @Html.Partial("dashboardIcons")

    <div ng-controller="searchController">
        <form>
            <div class="row">
                <div class="col-lg-8 col-sm-8 col-xs-8">
                    <div class="input-group">
                        <input type="text" class="form-control" ng-model="pageInfo.searchString" placeholder="Search for messages..." typeahead="searchField for searchField in searchFields | filter:$viewValue">
                        <span class="input-group-btn">
                            <button class="btn btn-default" ng-disabled="searchProgress > 0" ng-click="newSearch()" type="submit"><i class="glyphicon glyphicon-search"></i></button>
                            <button class="btn btn-default" popover-title="Fields" popover="Any (default) incudes all fields + body or use ClassName, IsError, EnvironmentId, TimeSent. (e.g. IsError:false AND EnvironmentId:real-prod)" type="submit"><i class="glyphicon glyphicon-question-sign"></i></button>
                        </span>
                    </div>
                </div>
                <div class="col-lg-4 col-sm-4 col-xs-4">
                    <div class="input-group">
                        <div class="btn-group">
                            <label class="btn btn-primary" ng-model="pageInfo.take" btn-radio="10" ng-disabled="searchProgress > 0">10</label>
                            <label class="btn btn-primary" ng-model="pageInfo.take" btn-radio="20" ng-disabled="searchProgress > 0">20</label>
                            <label class="btn btn-primary" ng-model="pageInfo.take" btn-radio="50" ng-disabled="searchProgress > 0">50</label>
                            <label class="btn btn-primary" ng-model="pageInfo.take" btn-radio="100" ng-disabled="searchProgress > 0">100</label>
                        </div>
                        <span>&nbsp; Per Page</span>
                    </div>
                </div>
            </div>
            <div class="row toolbar">
                <div class="col-lg-1 col-sm-1 col-xs-1">
                    <button class="btn btn-default" popover="retry" type="submit" ng-disabled="!allowRetry || searchProgress > 0"><i class="glyphicon glyphicon-repeat"></i></button>
                </div>
                <div class="col-lg-11 col-sm-11 col-xs-11">
                    <progressbar max="100" value="searchProgress" ng-show="searchProgress > 0"><span class="searchProgressBar">Searching...</span></progressbar>
                </div>
            </div>
        </form>
        <div class="table-responsive" ng-show="searchProgress === 0">
            <table class="table table-striped table-condensed table-hover">
                <thead>
                <tr>
                    <th>#</th>
                    <th ng-click="toggleSort('EnvironmentId')" class="clickable">
                        <i class="glyphicon glyphicon-chevron-up" ng-show="pageInfo.sortField === 'EnvironmentId' && pageInfo.sortAscending"></i>
                        <i class="glyphicon glyphicon-chevron-down" ng-show="pageInfo.sortField === 'EnvironmentId' && !pageInfo.sortAscending"></i>
                        Environment
                    </th>
                    <th ng-click="toggleSort('ClassName')" class="clickable">
                        <i class="glyphicon glyphicon-chevron-up" ng-show="pageInfo.sortField === 'ClassName' && pageInfo.sortAscending"></i>
                        <i class="glyphicon glyphicon-chevron-down" ng-show="pageInfo.sortField === 'ClassName' && !pageInfo.sortAscending"></i>
                        Class
                    </th>
                    <th ng-click="toggleSort('TimeSent')" class="clickable">
                        <i class="glyphicon glyphicon-chevron-up" ng-show="pageInfo.sortField === 'TimeSent' && pageInfo.sortAscending"></i>
                        <i class="glyphicon glyphicon-chevron-down" ng-show="pageInfo.sortField === 'TimeSent' && !pageInfo.sortAscending"></i>
                        Time Sent
                    </th>
                    <th ng-click="toggleSort('IsError')" class="clickable">
                        <i class="glyphicon glyphicon-chevron-up" ng-show="pageInfo.sortField === 'IsError' && pageInfo.sortAscending"></i>
                        <i class="glyphicon glyphicon-chevron-down" ng-show="pageInfo.sortField === 'IsError' && !pageInfo.sortAscending"></i>
                        Is Error
                    </th>
                    <th ng-click="toggleSort('CanRetry')" class="clickable">
                        <i class="glyphicon glyphicon-chevron-up" ng-show="pageInfo.sortField === 'CanRetry' && pageInfo.sortAscending"></i>
                        <i class="glyphicon glyphicon-chevron-down" ng-show="pageInfo.sortField === 'CanRetry' && !pageInfo.sortAscending"></i>
                        Can Retry
                    </th>
                    <th>Select</th>
                </tr>
                </thead>
                <tbody>
                <tr class="clickable" ng-repeat="result in searchResults.results">
                    <td ng-click="showDetails(result, $event)">{{result.id}}</td>
                    <td ng-click="showDetails(result, $event)">{{result.environmentId}}</td>
                    <td ng-click="showDetails(result, $event)">{{result.messageTypes.length > 0 ? result.messageTypes[0].className : 'UNK'}}</td>
                    <td ng-click="showDetails(result, $event)">{{result.formattedTimeSent}}</td>
                    <td ng-click="showDetails(result, $event)">{{result.isError}}</td>
                    <td ng-click="showDetails(result, $event)">{{result.canRetry}}</td>
                    <td><input type="checkbox" ng-model="result.isSelected" ng-click="selectionChanged()"/></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="col-lg-4 col-sm-4 col-xs-4">
            <pager ng-show="pageInfo.totalPages > 1 && searchProgress === 0" total-items="pageInfo.totalItems" ng-model="pageInfo.page" ng-change="search()"></pager>
        </div>
        <div class="col-lg-4 col-sm-4 col-xs-4 pull-right">
            <pre ng-show="pageInfo.totalPages > 1">Page: {{pageInfo.page}} / {{pageInfo.totalPages}}</pre>
        </div>
    </div>
</div>

@section Script {
    <script src="/content/SignalR/jquery.signalR-2.2.0.min.js"></script>
    <script src="../signalr/hubs" type="text/javascript"></script>
    <script src="/content/App/Dashboard/searchService.js"></script>
    <script src="/content/App/Dashboard/dashboardController.js"></script>
    <script src="/content/App/Dashboard/searchController.js"></script>
    <script src="/content/App/Dashboard/searchDetailController.js"></script>
}